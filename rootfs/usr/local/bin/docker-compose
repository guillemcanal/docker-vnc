#!/usr/bin/env bash

## A docker-compose wrapper that resolve directory paths for mounted volumes

set -e

main() {
	local CURRENT_PATH="$(pwd)"
	local CONTAINER_ID="$(hostname)"
	local DOCKER_BIN="$(which -a docker | tail -n1)"
	local DOCKER_COMPOSER_BIN="$(which -a docker-compose | tail -n1)"
	local VOLUMES="$($DOCKER_BIN inspect --format='{{range .Mounts}}{{ if and (eq .Type "volume") }}{{printf "%s:%s\n" .Source .Destination}}{{end}}{{end}}' $HOSTNAME | sed '/^$/d')"

	for VOLUME in $VOLUMES;do
		local VOLUME_SRC="${VOLUME%%:*}"
		local VOLUME_DST="${VOLUME#*:}"
		if [[ "$CURRENT_PATH" =~ ^${VOLUME_DST} ]];then
			CURRENT_PATH=$VOLUME_SRC
		fi
	done
	
	$DOCKER_COMPOSER_BIN --project-directory=$CURRENT_PATH "$@"
}

main "$@"
